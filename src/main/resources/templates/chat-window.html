<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>Чат</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .animate-fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
  </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col relative">



<!-- Header (sticky) -->
<div class="sticky top-0 z-20 bg-gray-800/30 backdrop-blur-sm border-b border-gray-700/50">
  <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
    <a href="/chat" class="text-gray-400 hover:text-white transition-colors duration-200">← Назад</a>
    <div class="flex items-center gap-3">
      <!-- Avatar / Initials -->
      <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-gray-700 flex items-center justify-center text-white font-bold text-sm uppercase">
        <img th:if="${chatPartner.avatarUrl != null}" th:src="@{${chatPartner.avatarUrl}}" alt="Avatar" class="w-full h-full object-cover"/>
        <div th:if="${chatPartner.avatarUrl == null}" class="w-full h-full bg-blue-600 flex items-center justify-center text-white font-bold">
          <span th:text="${chatPartner.fullName != null} ? ${chatPartner.fullName.substring(0,1)} : ${chatPartner.username.substring(0,1)}"></span>
        </div>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-white"
            th:text="${chatPartner.fullName != null} ? ${chatPartner.fullName} : ${chatPartner.username}">Име</h2>
      </div>
    </div>
    <div class="w-10"></div>
  </div>
</div>

<!-- Messages container -->
<div class="relative z-10 flex-1">
  <div id="messagesContainer"
       class="max-w-4xl mx-auto px-4 py-6 space-y-4 overflow-y-auto h-full"
       style="scroll-behavior: smooth; padding-bottom:6rem;">
    <div th:each="msg, iterStat : ${messages}"
         th:attr="data-message-id=${msg.id}, id=${iterStat.last} ? 'lastMessage' : null">
      <!-- Incoming -->
      <div th:if="${msg.sender.username != #authentication.name}" class="flex justify-start px-6">
        <div class="max-w-[60%] px-5 py-3 rounded-2xl bg-gray-800/70 backdrop-blur-sm border border-gray-700/50 text-gray-100 animate-fade-in break-words">
          <p class="text-sm break-words whitespace-pre-wrap" th:text="${msg.messageText}">Съобщение</p>
          <p class="text-xs mt-1 text-gray-400" th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">09:30</p>
          <p class="text-[10px] mt-1 text-left text-gray-400 seen-status" th:if="${msg.read}" style="display:block;">✓ Видяно</p>
          <p class="text-[10px] mt-1 text-left text-gray-400 seen-status" th:if="${!msg.read}" style="display:none;">✓ Видяно</p>
        </div>
      </div>
      <!-- Outgoing -->
      <div th:if="${msg.sender.username == #authentication.name}" class="flex justify-end px-6">
        <div class="max-w-[60%] px-5 py-3 rounded-2xl bg-gradient-to-r from-blue-500 to-purple-600 text-white animate-fade-in break-words">
          <p class="text-sm break-words whitespace-pre-wrap" th:text="${msg.messageText}">Съобщение</p>
          <p class="text-xs mt-1 text-blue-100" th:text="${#temporals.format(msg.timestamp, 'HH:mm')}">09:32</p>
          <p class="text-[10px] mt-1 text-right text-blue-200 seen-status" th:if="${msg.read}" style="display:block;">✓ Видяно</p>
          <p class="text-[10px] mt-1 text-right text-blue-200 seen-status" th:if="${!msg.read}" style="display:none;">✓ Видяно</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Input (sticky bottom) -->
<div class="sticky bottom-0 z-20 bg-gray-800/30 backdrop-blur-sm border-t border-gray-700/50">
  <div class="max-w-4xl mx-auto px-4 py-4">
    <form id="chatForm" class="flex gap-3" onsubmit="sendMessage(event)">
      <input
              type="text"
              name="message"
              placeholder="Напиши съобщение..."
              class="flex-1 px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
      />
      <button
              type="submit"
              class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:from-blue-600 hover:to-purple-700 transition-all duration-200"
      >
        Изпрати
      </button>
    </form>
  </div>
</div>

<!-- Sound -->
<audio id="notificationSound" src="/sounds/notification.mp3" preload="auto"></audio>

<script th:inline="javascript">
  /*<![CDATA[*/
  let stompClient = null;
  const username = /*[[${#authentication.name}]]*/ 'user';
  const partnerUsername = /*[[${chatPartner.username}]]*/ 'partner';
  const shownMessages = new Set();

  function connect() {
    const socket = new SockJS('/ws-chat');
    stompClient = Stomp.over(socket);
    stompClient.debug = null;

    stompClient.connect({}, () => {
      console.log('✅ STOMP connected');
      stompClient.subscribe('/user/queue/messages', (messageOutput) => {
        const msg = JSON.parse(messageOutput.body);

        if (shownMessages.has(msg.id)) {
          updateReadStatus(msg.id, msg.read);
        } else {
          showMessage(msg);
          if (msg.sender.username !== username) {
            playNotificationSound();
          }
        }
      });
    }, (error) => {
      console.error('❌ STOMP connection error:', error);
    });
  }

  function sendMessage(event) {
    event.preventDefault();
    const input = document.querySelector('input[name="message"]');
    const text = input.value.trim();
    if (!text) return;

    const chatMessage = {
      content: text,
      receiverUsername: partnerUsername
    };

    if (stompClient && stompClient.connected) {
      stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
    } else {
      alert('Няма връзка със сървъра!');
    }

    input.value = '';
  }

  function showMessage(msg) {
    if (shownMessages.has(msg.id)) return;

    shownMessages.add(msg.id);
    const container = document.getElementById('messagesContainer');
    const isSender = msg.sender.username === username;
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const messageElement = document.createElement('div');
    messageElement.className = `flex ${isSender ? 'justify-end' : 'justify-start'} px-6 mt-4`;
    messageElement.setAttribute('data-message-id', msg.id);

    const seenHtml = (isSender && msg.read)
      ? `<p class="text-[10px] mt-1 text-right text-blue-200 seen-status" style="display:block;">✓ Видяно</p>`
      : '';

    messageElement.innerHTML = `
      <div class="max-w-[60%] px-5 py-3 rounded-2xl break-words ${
        isSender
          ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white animate-fade-in'
          : 'bg-gray-800/70 backdrop-blur-sm border border-gray-700/50 text-gray-100 animate-fade-in'
      }">
        <p class="text-sm">${escapeHtml(msg.messageText)}</p>
        <p class="text-xs mt-1 ${isSender ? 'text-blue-100' : 'text-gray-400'}">${time}</p>
        ${seenHtml}
      </div>`;

    container.appendChild(messageElement);

    // Скрол долу, когато получаваме ново съобщение от другия
    if (!isSender) {
      container.scrollTop = container.scrollHeight;
    }
  }

  function updateReadStatus(messageId, read) {
    const container = document.getElementById('messagesContainer');
    const messageDiv = container.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageDiv) return;

    const seenStatus = messageDiv.querySelector('.seen-status');
    if (seenStatus) {
      seenStatus.style.display = read ? 'block' : 'none';
    } else if (read) {
      const statusElem = document.createElement('p');
      statusElem.className = 'text-[10px] mt-1 text-right text-blue-200 seen-status';
      statusElem.textContent = '✓ Видяно';
      messageDiv.querySelector('div').appendChild(statusElem);
    }
  }

  function playNotificationSound() {
    const audio = document.getElementById('notificationSound');
    if (audio) {
      audio.play().catch(() => {});
    }
  }

  function escapeHtml(text) {
    return text.replace(/&/g, "&amp;")
               .replace(/</g, "&lt;")
               .replace(/>/g, "&gt;")
               .replace(/"/g, "&quot;")
               .replace(/'/g, "&#039;");
  }

  // Скрол до последното съобщение след пълно зареждане на страницата
  window.addEventListener('load', () => {
  const container = document.getElementById('messagesContainer');
  if (!container) return;

  // Малка пауза, за да са рендерирани всички елементи
  setTimeout(() => {
    const lastMessage = document.getElementById("lastMessage");
    if (lastMessage) {
      lastMessage.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  }, 50);

  connect();
});

  /*]]>*/
</script>

</body>
</html>
